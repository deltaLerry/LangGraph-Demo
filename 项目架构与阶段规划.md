## 一、对照《产品设计文档.md》的“预期”

文档核心预期（MVP优先）：
- **工作流闭环**：策划 → 写手 → 主编（不通过可返工）
- **输出形态**：输入一个点子，输出一段逻辑通顺的短文（首章/开篇）
- **策划输出约束**：策划必须输出**严格 JSON**（便于后续并行分发/存档）
- **技术选型**：LangGraph + Python；模型（DeepSeek/通义千问）；存储（本地文件系统）

## 二、现状检查（仓库与实现）

### 已符合预期的部分
- **LangGraph图结构**：已经具备“线性 + 条件回边”的返工闭环思路（与MVP一致）。
- **角色划分**：已有`planner / writer / editor`三个agent雏形。

### 不符合预期/会阻塞迭代的部分（已调整）
- **依赖缺失**：`requirements.txt`为空会导致无法安装/运行（已补齐）。
- **状态不完整**：`StoryState`未声明`editor_feedback/needs_rewrite`等字段（已补齐）。
- **重复且误导的代码**：存在`workflow_state.py/workflow_nodes.py`等未使用文件，且引用不存在模块（已删除并收敛为统一`workflow.py`）。
- **输出未沉淀**：未将结果落盘（不符合“本地文件系统存储”预期）（已加`outputs/`落盘）。
- **模型可选接入缺口**：没有统一的LLM配置入口（已新增统一OpenAI兼容配置，可接DeepSeek/通义千问）。

## 三、最新项目结构（建议结构）

当前收敛后的核心结构：
- `src/main.py`：CLI入口，组装配置、运行工作流、落盘输出
- `src/workflow.py`：LangGraph图（策划→写手→主编，主编不通过可返工，受`max_rewrites`限制）
- `src/state.py`：统一状态`StoryState`
- `src/agents/`：`planner.py / writer.py / editor.py`
- `src/config.py`：从环境变量加载LLM配置
- `src/llm.py`：构建OpenAI兼容Chat模型（可选）
- `src/storage.py`：本地落盘辅助（run目录、json/md写入）
- `outputs/`：每次运行的结果目录（自动生成）

## 四、核心设计（MVP）

### 1) 状态设计（StoryState）
- **输入**：`user_input`、`target_words`
- **控制**：`max_rewrites`、`writer_version`
- **产物**：`planner_result/planner_json`、`writer_result`、`editor_decision/editor_feedback`
- **工作流控制**：`needs_rewrite`
- **外部依赖**：`llm`（可选注入，未配置时走模板）
- **存储**：`output_dir`

### 2) Agent职责边界
- **planner**：只负责“拆解任务 + 严格JSON输出”（为后续多角色并行铺路）
- **writer**：生成首章/开篇；若主编不通过，则基于修改意见重写
- **editor**：质量把关；输出严格为“审核通过”或“审核不通过 + 具体修改清单”

### 3) 存储与可追溯
- 每次运行生成一个run目录，至少包含：
  - `planner.json`
  - `chapter_1.md`
  - `editor.md`
- 该设计为后续“设定管理/知识库”阶段预留接口（同一run目录下追加`world.json/characters.json/outline.json`等即可）。

## 五、阶段规划（与原文档一致，但补充验收标准与交付物）

### 阶段1：核心工作流验证（1~2周）
- **目标**：输入点子 → 输出逻辑通顺短文 → 主编审核（可返工）→ 结果落盘。
- **交付物**：
  - CLI可运行：`python src/main.py --idea "..."`
  - `outputs/`目录产出固定三件套（planner/chapter/editor）
  - 模板模式可跑通；LLM配置后可产出更自然文稿
- **验收标准**：
  - planner输出为严格JSON（可`json.loads`）
  - editor输出严格遵守“审核通过/审核不通过”规则
  - 返工次数受`max_rewrites`限制，不死循环

### 阶段2：设定管理建设（2~3周）
- **目标**：系统“有记忆”，能管理复杂设定（世界观/人物卡/时间线/禁忌规则等）。
- **交付物**：
  - 新增设定结构：`world.json`、`characters.json`、`timeline.json`（本地文件）
  - 设定读取/更新接口：按project/run维度组织
  - editor增加“一致性校验”基于设定文件
- **验收标准**：生成的新章节不与既有设定矛盾（至少可检测出矛盾并返工）。

### 阶段3：多角色写作闭环（3~4周）
- **目标**：扩展为多角色并行：架构师/角色导演/编剧等产出结构化材料，再由写手写正文，主编审。
- **交付物**：
  - LangGraph并行分支：世界观/角色/细纲并行生成与汇总
  - “材料包”落盘：`world.json`、`characters.json`、`outline.json`、`chapter_1.md`
- **验收标准**：人物言行与人物卡一致；主线不自相矛盾；可稳定产出“项目包”。

### 阶段4：系统智能升级（持续）
- **目标**：顾问咨询 + 反思/持续成长，减少前后矛盾与AI味。
- **交付物**：
  - “顾问”问答入口（基于已落盘的设定与历史章节）
  - 生成时自动引用设定、自动检查矛盾并提出改稿建议
- **验收标准**：同题材多章节生成时，矛盾率下降；返工次数降低；用户可追溯每次决策依据。

## 六、下一步建议（最小增量）
- **先稳定阶段1**：把“LLM配置、可跑通、可落盘”当作第一验收门槛。
- **再做阶段2**：优先落盘结构化设定（哪怕先由planner生成最小版世界观/人物卡）。


